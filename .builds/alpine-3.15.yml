image: alpine/3.15
packages:
  - php8-cli
  - php8-dom
  - php8-tokenizer
  - php8-simplexml
  - php8-xml
  - php8-xmlwriter
  - php8-xdebug
  - composer
sources:
  - https://git.sr.ht/~cjw6k/chapeau
tasks:
  - setup: |
      sudo ln -s /usr/bin/php8 /usr/bin/php
      sudo sed -i 's/memory_limit\s*=.*/memory_limit=1G/g' /etc/php8/php.ini
      sudo sed -i 's/;zend/zend/g' /etc/php8/conf.d/50_xdebug.ini
      sudo sed -i 's/;xdebug/xdebug/g' /etc/php8/conf.d/50_xdebug.ini
  - composer: |
      cd ~/chapeau
      composer install
  - phpcs: |
      cd ~/chapeau
      vendor/bin/phpcs
  - psalm: |
      cd ~/chapeau
      vendor/bin/psalm
  - phpunit: |
      cd ~/chapeau
      XDEBUG_MODE=coverage vendor/bin/phpunit --coverage-html tests/coverage --path-coverage
  - coverage: |
      tar czvf coverage.tar.gz -C chapeau/tests/coverage .
artifacts:
  - coverage.tar.gz
